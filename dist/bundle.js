var game;(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{main:()=>T});var s="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;var i=Math.PI/180;function r(t){return t*i}function n(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var o;o=new s(3),s!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0);const h={world:null,input:null,rm:null,selector:["dirt","stone","glass","sand","wood","leaf","bricks","planks","water"]};class a{static collision(t,e){e instanceof Set||(e=new Set);for(var s=Math.floor(t.position[0]),i=Math.floor(t.position[1]),r=Math.floor(t.position[2]),n=Math.floor(t.position[0]+t.size[0]),o=Math.floor(t.position[1]+t.size[1]),a=Math.floor(t.position[2]+t.size[2]),l=!1,d=null,c=null,u=null,m=null,g=null,p=null,f=new Set,v=!1,w=s;w<=n;w++)for(var k=i;k<=o;k++)for(var x=r;x<=a;x++)1==h.world.getBlock(w,k,x).nocoll||e.has([w,k,x].join(","))?"water"==h.world.getBlock(w,k,x).name&&(v=!0):(l=!0,d=this.max(w+1,d),m=this.min(w,m),c=this.max(k+1,c),g=this.min(k,g),u=this.max(x+1,u),p=this.min(x,p),f.add([w,k,x].join(",")));return{collision:l,max:[d,c,u],min:[m,g,p],blocks:f,water:v}}static max(t,e){return null==t?e:null==e||t>e?t:e}static min(t,e){return null==t?e:null==e||t<e?t:e}}class l{constructor(t,e,s){this.world=h.world,this.position=t.slice(0),this.dir=new Array(3),this.max=s,function(t,e){var s=e[0],i=e[1],r=e[2],n=s*s+i*i+r*r;n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(this.dir,e)}getBlock(t){var e,s,i,r=null,o=this.position.slice(),a=new Array(3),l=new Array(3);!function(t,e,s){t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s}(a,this.dir,t);for(var d=0;d<this.max&&(n(l,o,a),e=Math.floor(l[0]),s=Math.floor(l[1]),i=Math.floor(l[2]),(r=h.world.getBlock(e,s,i)).nocoll);d+=t)o=l.slice(0);var c=Math.floor(o[0])-e,u=Math.floor(o[1])-s,m=Math.floor(o[2])-i;return r.nocoll?null:{block:r,position:[e,s,i],normal:[c,u,m]}}}class d{constructor(t,e,s){this.world=t,this.pos=e.slice(0),this.rot=s.slice(0),this.speed=5,this.rotSpeed=15,this.width=.8,this.height=1.9,this.vspeed=0,this.movingCamera=!1,this.buildBlock="grass",this.pressing=!1,this.state=0,this.setGravityAndJump(1.2,.5)}raycast(){var t=h.world.render.screenToWorld(h.input.mouseX,h.input.mouseY);!function(t,e,s){t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2]}(t,t,this.eyePos);var e=new l(this.eyePos,t,20);this.rBlock=e.getBlock(.05)}setGravityAndJump(t,e){this.jumpSpeed=4*t/e,this.gravity=2*this.jumpSpeed/e}update(t){this.raycast(),h.input.keypress("noclip")&&(this.state=1),h.input.keypress("physics")&&(this.state=0),0!=h.input.mousePressed&&(this.pressing=!0,(Math.abs(h.input.deltaX)-4>0||Math.abs(h.input.deltaY)-4>0)&&(this.movingCamera=!0)),0==h.input.mousePressed&&(this.movingCamera||null!=this.rBlock&&this.pressing&&h.world.setBlock(this.rBlock.position[0],this.rBlock.position[1],this.rBlock.position[2],"air",!0),this.pressing=!1,this.movingCamera=!1),this.movingCamera&&(this.rot[1]+=h.input.deltaX*t*this.rotSpeed,this.rot[0]+=h.input.deltaY*t*this.rotSpeed,this.rot[0]<-75&&(this.rot[0]=-75),this.rot[0]>75&&(this.rot[0]=75)),1==h.input.mouseRightPressed&&null!=this.rBlock&&h.world.setBlock(this.rBlock.position[0]+this.rBlock.normal[0],this.rBlock.position[1]+this.rBlock.normal[1],this.rBlock.position[2]+this.rBlock.normal[2],this.buildBlock,!0),0==this.state?this.updatePhysics(t):this.updateNoclip(t)}updateNoclip(t){var e=this.rotation[1],s=0,i=0,n=0;h.input.keypress("w")&&(n-=Math.cos(r(e))*t*this.speed,s+=Math.sin(r(e))*t*this.speed),h.input.keypress("s")&&(n+=Math.cos(r(e))*t*this.speed,s-=Math.sin(r(e))*t*this.speed),h.input.keypress("d")&&(n+=Math.sin(r(e))*t*this.speed,s+=Math.cos(r(e))*t*this.speed),h.input.keypress("a")&&(n-=Math.sin(r(e))*t*this.speed,s-=Math.cos(r(e))*t*this.speed),h.input.keypress("jump")&&(i+=this.speed*t),h.input.keypress("shift")&&(i-=this.speed*t),this.pos[0]+=s,this.pos[1]+=i,this.pos[2]+=n}updatePhysics(t){this.checkWater();var e=this.rotation[1],s=(e=this.rotation[1],0),i=0,n=0;h.input.keypress("w")&&(n-=Math.cos(r(e))*t*this.speed,s+=Math.sin(r(e))*t*this.speed),h.input.keypress("s")&&(n+=Math.cos(r(e))*t*this.speed,s-=Math.sin(r(e))*t*this.speed),h.input.keypress("d")&&(n+=Math.sin(r(e))*t*this.speed,s+=Math.cos(r(e))*t*this.speed),h.input.keypress("a")&&(n-=Math.sin(r(e))*t*this.speed,s-=Math.cos(r(e))*t*this.speed);var o=1;this.onWater?(h.input.keypress("jump")&&this.canSwim&&(this.vspeed=this.jumpSpeed/3),o=.25):h.input.keypress("jump")&&this.ground&&(this.vspeed=this.jumpSpeed),this.vspeed-=this.gravity*o*t,i+=this.vspeed*t,this.movePlayer(s,i,n)}checkWater(){var t=a.collision(this.collbox);this.onWater=t.water;var e=this.collbox;e.size[1]/=6,e.position[1]+=e.size[1],this.canSwim=a.collision(e).water}movePlayer(t,e,s){var i,r=a.collision(this.collbox).blocks;0!=e&&(this.pos[1]+=e,(i=a.collision(this.collbox,r)).collision?(e<0&&(this.ground=!0,this.vspeed=0),this.pos[1]=e>0?i.min[1]-.01-this.height:i.max[1]):this.ground=!1),0!=t&&(this.pos[0]+=t,(i=a.collision(this.collbox,this.world,r)).collision&&(this.pos[0]=t>0?i.min[0]-.01-this.width/2:i.max[0]+.01+this.width/2)),0!=s&&(this.pos[2]+=s,(i=a.collision(this.collbox,this.world,r)).collision&&(this.pos[2]=s>0?i.min[2]-.01-this.width/2:i.max[2]+.01+this.width/2))}get position(){return this.pos.slice()}get rotation(){return this.rot.slice()}get collbox(){return{position:[this.pos[0]-this.width/2,this.pos[1],this.pos[2]-this.width/2],size:[this.width,this.height,this.width]}}get eyePos(){return[this.pos[0],this.pos[1]+1.8,this.pos[2]]}}const c=[{name:"air",nocoll:!0,air:!0,transparent:!0},{name:"nopass",air:!0,transparent:!0},{name:"dirt",top:[0,0],bottom:[0,0],sides:[0,0],refresh:function(t,e,s,i){var r=h.world.getBlock(e,s+1,i);if(r.transparent&&"water"!=r.name)for(var n=s-1;n<=s+1;n++){var o=h.world.getBlock(e-1,n,i).name,a=h.world.getBlock(e+1,n,i).name,l=h.world.getBlock(e,n,i+1).name,d=h.world.getBlock(e,n,i-1).name;if("grass"==o||"grass"==a||"grass"==l||"grass"==d){h.world.setBlock(e,s,i,"grass",!0);break}}}},{name:"water",nocoll:!0,transparent:!0,top:[3,0],bottom:[3,0],sides:[3,0],refresh:function(t,e,s,i){h.world.getBlock(e-1,s,i).air&&h.world.setBlock(e-1,s,i,"water",!0),h.world.getBlock(e+1,s,i).air&&h.world.setBlock(e+1,s,i,"water",!0),h.world.getBlock(e,s-1,i).air&&h.world.setBlock(e,s-1,i,"water",!0),h.world.getBlock(e,s,i-1).air&&h.world.setBlock(e,s,i-1,"water",!0),h.world.getBlock(e,s,i+1).air&&h.world.setBlock(e,s,i+1,"water",!0)}},{name:"grass",top:[0,3],bottom:[0,0],sides:[1,3],refresh:function(t,e,s,i){var r=h.world.getBlock(e,s+1,i);r.transparent&&"water"!=r.name||h.world.setBlock(e,s,i,"dirt",!0)}},{name:"snowgrass",top:[2,3],bottom:[0,0],sides:[3,3]},{name:"snow",top:[2,3],bottom:[2,3],sides:[2,3]},{name:"stone",top:[1,0],bottom:[1,0],sides:[1,0]},{name:"sand",top:[2,0],bottom:[2,0],sides:[2,0],refresh:function(t,e,s,i){h.world.getBlock(e,s-1,i).nocoll&&(h.world.setBlock(e,s,i,"air",!0),h.world.setBlock(e,s-1,i,"sand",!0))}},{name:"glass",top:[0,2],bottom:[0,2],sides:[0,2],transparent:!0},{name:"wood",top:[1,1],bottom:[1,1],sides:[0,1]},{name:"leaf",top:[2,1],bottom:[2,1],sides:[2,1]},{name:"bricks",top:[1,2],bottom:[1,2],sides:[1,2]},{name:"planks",top:[3,2],bottom:[3,2],sides:[3,2]}];class u{constructor(t,e,s){this.generated=!1,this.render=s,this.size=t,this.height=e,this.renderDistance=8,this.updateTicks=4,this.updateWait=0,this.cl=16,this.blockMaps=new Map;var i=this;c.forEach((function(t,e){t.id=e,i.blockMaps.set(t.name,t)})),this.map=new Int16Array(this.numChunks*this.chunkVolume),this.chunks=new Map,this.refresh=new Array,this.nextRefresh=new Array,this.createBorders()}get numChunks(){return this.size*this.size*this.height}get chunkVolume(){return this.cl*this.cl*this.cl}get worldLength(){return this.cl*this.size}get worldHeight(){return this.cl*this.height}autoLoadChunks(){var t=this;this.interval=setInterval((function(){t.loader()}),100),this.fchunks=setInterval((function(){t.freeChunks()}),100)}stopAutoLoad(){clearInterval(this.interval),clearInterval(this.fchunks)}freeChunks(){const t=this;var e=[];this.chunks.forEach((function(s,i){var r=Math.floor(Math.abs(s.position[0]*t.cl+t.cl/2-t.player.eyePos[0])/t.cl),n=Math.floor(Math.abs(s.position[2]*t.cl+t.cl/2-t.player.eyePos[2])/t.cl);(r>t.renderDistance||n>t.renderDistance)&&e.push(i)})),e.forEach((function(e){t.render.freeChunk(e),t.chunks.delete(e)}))}loader(){var t=0,e=0,s=0,i=1,r=Math.floor(Math.max(0,this.player.eyePos[0]/this.cl-i)),n=Math.floor(Math.max(0,this.player.eyePos[2]/this.cl-i)),o=Math.floor(Math.min(this.size-1,this.player.eyePos[0]/this.cl+i)),h=Math.floor(Math.min(this.size-1,this.player.eyePos[2]/this.cl+i));for(t=r,e=0,s=n;null!=this.chunks.get(this.chunkHash(t,e,s));)if(++e>=this.height&&(e=0,++t>o&&(t=r,++s>h))){if(++i>this.renderDistance)return;r=Math.floor(Math.max(0,this.player.eyePos[0]/this.cl-i)),n=Math.floor(Math.max(0,this.player.eyePos[2]/this.cl-i)),o=Math.floor(Math.min(this.size-1,this.player.eyePos[0]/this.cl+i)),h=Math.floor(Math.min(this.size-1,this.player.eyePos[2]/this.cl+i)),t=r,s=n}for(e=0;e<this.height;e++)null==this.chunks.get(this.chunkHash(t,e,s))&&this.chunks.set(this.chunkHash(t,e,s),{position:[t,e,s],dirty:!0})}createBorders(){var t={vertex:new Array(this.worldHeight*this.worldLength*24),coords:new Array(this.worldHeight*this.worldLength*8),indices:new Array(this.worldHeight*this.worldLength*6)};const e=[0,1,0,1,1,0,1,0,0,0,0,0],s=this.blockMaps.get("glass").sides,i=[s[0]/16,s[1]/16,(s[0]+1)/16,(s[1]+1)/16];for(var r=0;r<this.worldLength;r++)for(var n=0;n<this.worldHeight;n++){const s=n*this.worldLength+r;for(var o=0;o<4;o++){const i=24*s+6*o;t.vertex[i+0]=r+e[0+3*o],t.vertex[i+1]=n+e[1+3*o],t.vertex[i+2]=0+e[2+3*o],t.vertex[i+3]=0,t.vertex[i+4]=0,t.vertex[i+5]=-1}t.indices[6*s+0]=4*s+2,t.indices[6*s+1]=4*s+1,t.indices[6*s+2]=4*s,t.indices[6*s+3]=4*s+3,t.indices[6*s+4]=4*s+2,t.indices[6*s+5]=4*s,t.coords[8*s+0]=i[0],t.coords[8*s+1]=i[1],t.coords[8*s+2]=i[2],t.coords[8*s+3]=i[1],t.coords[8*s+4]=i[2],t.coords[8*s+5]=i[3],t.coords[8*s+6]=i[0],t.coords[8*s+7]=i[3]}this.render.loadModel("wall","atlas",t),this.render.addInstance("wall",{position:[0,0,0],rotation:[0,0,0]}),this.render.addInstance("wall",{position:[this.worldLength,0,this.worldLength],rotation:[0,180,0]}),this.render.addInstance("wall",{position:[this.worldLength,0,0],rotation:[0,-90,0]}),this.render.addInstance("wall",{position:[0,0,this.worldLength],rotation:[0,90,0]})}placePlayer(){for(var t=[this.worldLength/2,this.worldHeight,this.worldLength/2],e=this.worldHeight;e>0;e--)if("air"!=this.getBlock(t[0],e-1,t[2]).name){t[1]=e+1;break}this.player=new d(this,t,[0,0,0])}generateTerrain(t,e){noise.seed(Math.random()),this.progress=0;var s=this,i=function(e,i,r){s.progress=0;var n=0,o=0,h=function(){t(i),e(n,o),s.progress+=1/(s.size*s.size),++n>=s.size&&(n=0,++o>=s.size)?r():requestAnimationFrame(h)};requestAnimationFrame(h)};i(s.generateChunkTerrain.bind(s),"Generating chunk terrain.",(function(){i(s.generateChunkCaves.bind(s),"Generating caves.",(function(){i(s.decorateChunk.bind(s),"Decorating chunks.",(function(){s.placePlayer(),e()}))}))}))}generateChunkTerrain(t,e){for(var s=t*this.cl;s<(t+1)*this.cl;s++)for(var i=e*this.cl;i<(e+1)*this.cl;i++)for(var r=(this.worldLength/2-s)/(this.worldLength/2),n=(this.worldLength/2-i)/(this.worldLength/2),o=Math.sqrt(r*r+n*n),h=Math.floor(53+6*noise.simplex2(s/50,i/50))-o*o*7,a=0;a<this.worldHeight;a++){var l;l=a<=h?"stone":a<=49?"water":"air",this.setBlock(s,a,i,l)}}generateChunkCaves(t,e){for(var s=t*this.cl;s<(t+1)*this.cl;s++)for(var i=e*this.cl;i<(e+1)*this.cl;i++)for(var r=0;r<this.worldHeight;r++){var n=(r/65+3*noise.simplex3(s/12,r/10,i/12)+10*noise.simplex3(s/80,r/20,i/80))/14,o=this.getBlock(s,r,i).name;n<-.5&&"stone"==o&&(o="air"),0==r&&(o="stone"),this.setBlock(s,r,i,o)}}decorateChunk(t,e){for(var s=t*this.cl;s<(t+1)*this.cl;s++)for(var i=e*this.cl;i<(e+1)*this.cl;i++)for(var r=-1,n=this.worldHeight-1;n>=0;n--){var o=this.getBlock(s,n,i).name,h=o,a=this.getBlock(s,n+1,i).name;-1==r&&"stone"==o&&("air"==a&&(h="grass",r=n),"water"==a&&(h="dirt",r=n)),"water"==a&&"air"==o?h="water":n>=r-4&&n<r&&(h="dirt"),this.setBlock(s,n,i,h)}}getBlock(t,e,s){return t<0||t>=this.worldLength||s<0||s>=this.worldLength||e<0||e>=this.worldHeight?this.blockMaps.get("nopass"):c[this.map[e*this.worldLength*this.worldLength+s*this.worldLength+t]]}updateChunk(t,e,s){if(!(t<0||t>=this.size||e<0||e>=this.height||s<0||s>=this.size)){var i=this.chunks.get(this.chunkHash(t,e,s));null!=i&&(i.dirty=!0)}}setBlock(t,e,s,i,r){if(!(t<0||t>=this.cl*this.size||s<0||s>=this.cl*this.size||e<0||e>=this.cl*this.height)){this.map[e*this.worldLength*this.worldLength+s*this.worldLength+t]=this.blockMaps.get(i).id;var n=Math.floor(t/this.cl),o=Math.floor(e/this.cl),h=Math.floor(s/this.cl);this.updateChunk(n,o,h),t%this.cl==0&&this.updateChunk(n-1,o,h),e%this.cl==0&&this.updateChunk(n,o-1,h),s%this.cl==0&&this.updateChunk(n,o,h-1),t%this.cl-1&&this.updateChunk(n+1,o,h),e%this.cl-1&&this.updateChunk(n,o+1,h),s%this.cl-1&&this.updateChunk(n,o,h+1),r&&(this.nextRefresh.push([t,e,s]),this.nextRefresh.push([t-1,e,s]),this.nextRefresh.push([t,e-1,s]),this.nextRefresh.push([t,e,s-1]),this.nextRefresh.push([t+1,e,s]),this.nextRefresh.push([t,e+1,s]),this.nextRefresh.push([t,e,s+1]))}}refreshBlock(t,e,s){var i=this.getBlock(t,e,s);null!=i.refresh&&i.refresh(this,t,e,s)}updateBlock(t,e,s){if("dirt"==this.getBlock(t,e,s).name)for(var i=e-1;i<=e+1;i++){var r=this.getBlock(t-1,i,s).name,n=this.getBlock(t+1,i,s).name,o=this.getBlock(t,i,s+1).name,h=this.getBlock(t,i,s-1).name,a=this.getBlock(t-1,i+1,s),l=this.getBlock(t+1,i+1,s),d=this.getBlock(t,i+1,s+1),c=this.getBlock(t,i+1,s-1);if("grass"==r&&a.transparent){this.setBlock(t,e,s,"grass",!0);break}if("grass"==n&&l.transparent){this.setBlock(t,e,s,"grass",!0);break}if("grass"==o&&d.transparent){this.setBlock(t,e,s,"grass",!0);break}if("grass"==h&&c.transparent){this.setBlock(t,e,s,"grass",!0);break}}}update(t){var e=this,s=!1;this.updateWait+=t,this.updateWait>=1/this.updateTicks&&(s=!1,this.updateWait=0);var i=this.nextRefresh;this.nextRefresh=[],e.refresh.length>0&&e.refresh.forEach((function(t){e.refreshBlock(t[0],t[1],t[2])})),this.refresh=i,this.chunks.forEach((function(t,i,r){if(s){var n=t.position[0]*e.cl+Math.floor(Math.random()*e.cl),o=t.position[1]*e.cl+Math.floor(Math.random()*e.cl),h=t.position[2]*e.cl+Math.floor(Math.random()*e.cl);e.updateBlock(n,o,h)}t.dirty&&(t.dirty=!1,e.render.generateChunkMesh(e,t.position))})),this.player.update(t),this.render.setCam(this.player.eyePos,this.player.rotation)}chunkHash(t,e,s){return e*this.size*this.size+s*this.size+t}}function m(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function g(t,e,s){var i,r,n,o,h,a,l,d,c,u,m,g,p=s[0],f=s[1],v=s[2];return e===t?(t[12]=e[0]*p+e[4]*f+e[8]*v+e[12],t[13]=e[1]*p+e[5]*f+e[9]*v+e[13],t[14]=e[2]*p+e[6]*f+e[10]*v+e[14],t[15]=e[3]*p+e[7]*f+e[11]*v+e[15]):(i=e[0],r=e[1],n=e[2],o=e[3],h=e[4],a=e[5],l=e[6],d=e[7],c=e[8],u=e[9],m=e[10],g=e[11],t[0]=i,t[1]=r,t[2]=n,t[3]=o,t[4]=h,t[5]=a,t[6]=l,t[7]=d,t[8]=c,t[9]=u,t[10]=m,t[11]=g,t[12]=i*p+h*f+c*v+e[12],t[13]=r*p+a*f+u*v+e[13],t[14]=n*p+l*f+m*v+e[14],t[15]=o*p+d*f+g*v+e[15]),t}function p(t,e,s,i){var r,n,o,h,a,l,d,c,u,m,g,p,f,v,w,k,x,y,M,b,B,E,T,A,C=i[0],_=i[1],R=i[2],P=Math.hypot(C,_,R);return P<1e-6?null:(C*=P=1/P,_*=P,R*=P,r=Math.sin(s),o=1-(n=Math.cos(s)),h=e[0],a=e[1],l=e[2],d=e[3],c=e[4],u=e[5],m=e[6],g=e[7],p=e[8],f=e[9],v=e[10],w=e[11],k=C*C*o+n,x=_*C*o+R*r,y=R*C*o-_*r,M=C*_*o-R*r,b=_*_*o+n,B=R*_*o+C*r,E=C*R*o+_*r,T=_*R*o-C*r,A=R*R*o+n,t[0]=h*k+c*x+p*y,t[1]=a*k+u*x+f*y,t[2]=l*k+m*x+v*y,t[3]=d*k+g*x+w*y,t[4]=h*M+c*b+p*B,t[5]=a*M+u*b+f*B,t[6]=l*M+m*b+v*B,t[7]=d*M+g*b+w*B,t[8]=h*E+c*T+p*A,t[9]=a*E+u*T+f*A,t[10]=l*E+m*T+v*A,t[11]=d*E+g*T+w*A,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}!function(){var t=new s(4);s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();class f{constructor(){this.chunkMeshes=new Map,this.models=new Map,this.canvas=document.getElementById("glCanvas"),this.gl=this.canvas.getContext("webgl2"),null!=this.gl?(h.rm.gl=this.gl,this.altas=h.rm.getTexture("atlas"),this.shader=h.rm.createShader("normal","#version 300 es\r\nprecision mediump float;\r\n\r\nlayout(location = 0) in vec3 vertPosition;\r\nlayout(location = 1) in vec3 normalPosition;\r\nlayout(location = 2) in vec2 vertTexCoord;\r\nout vec2 fragTexCoord;\r\nout float o_light;\r\nuniform mat4 modelMatrix;\r\nuniform mat4 viewMatrix;\r\nuniform mat4 projMatrix;\r\n\r\nvoid main()\r\n{\r\n  vec3 unitNormal = (modelMatrix * vec4(normalPosition, 0)).xyz;\r\n  o_light = min(1.0, max(0.5, dot(vec3(1, 2, 0.5), unitNormal)));\r\n  fragTexCoord = vertTexCoord;\r\n  gl_Position = projMatrix * viewMatrix * modelMatrix * vec4(vertPosition, 1.0);\r\n}","#version 300 es\r\nprecision mediump float;\r\n\r\nin vec2 fragTexCoord;\r\nin float o_light;\r\nuniform sampler2D sampler;\r\nout vec4 fragColor;\r\n\r\nvoid main()\r\n{\r\n  fragColor = texture(sampler, fragTexCoord);\r\n  float a = fragColor.a;\r\n  fragColor = fragColor * o_light;\r\n  fragColor.a = a;\r\n}"),this.mUniform=this.shader.getUniform("modelMatrix"),this.vUniform=this.shader.getUniform("viewMatrix"),this.pUniform=this.shader.getUniform("projMatrix"),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE),this.gl.sampleCoverage(.9,!1),this.gl.frontFace(this.gl.CW),this.gl.cullFace(this.gl.FRONT),this.pMatrix=new Float32Array(16),this.mvMatrix=new Float32Array(16),this.vMatrix=new Float32Array(16),this.sToWorld=new Float32Array(16),this.resizeCanvas(800,600),this.setCam([0,0,0],[0,0,0])):alert("Cannot use webgl")}get opengl(){return this.gl}loadModel(t,e,s){var i=this.models.get(t);null!=i&&(i.mesh.free(),i.tex.free()),i={mesh:h.rm.createMesh(t+"_m",s),tex:h.rm.getTexture(e),instances:new Set},this.models.set(t,i)}freeModel(t){var e=this.models.get(t);null!=e&&(h.rm.freeMesh(t+"_m"),this.models.delete(e))}addInstance(t,e){var s=this.models.get(t).instances,i=new Float32Array(16);m(i),g(i,i,e.position),p(i,i,r(e.rotation[0]),[1,0,0]),p(i,i,r(e.rotation[1]),[0,1,0]),p(i,i,r(e.rotation[2]),[0,0,1]),e.matrix=i,s.add(e)}clearColor(t,e,s){this.gl.clearColor(t,e,s,1)}freeChunk(t){var e=this.chunkMeshes.get(t);null!=e&&(null!=e.block_mesh&&h.rm.freeMesh(t+"_bm"),null!=e.water_mesh&&h.rm.freeMesh(t+"_wm")),this.chunkMeshes.delete(t)}generateChunkMesh(t,e){const s=h.world.chunkHash(e[0],e[1],e[2]);this.chunkMeshes.get(s),this.freeChunk(s);let i={vertex:[],indices:[],coords:[]},r={vertex:[],indices:[],coords:[]};for(var n=0;n<h.world.cl;n++)for(var o=0;o<h.world.cl;o++)for(var a=0;a<h.world.cl;a++){var l=n+e[0]*h.world.cl,d=o+e[1]*h.world.cl,c=a+e[2]*h.world.cl,u=h.world.getBlock(l,d,c),p=function(t,e,s,i){for(var r=Math.floor(i.vertex.length/6),h=0;h<4;h++)i.vertex.push(n+t[0+3*h]),i.vertex.push(o+t[1+3*h]),i.vertex.push(a+t[2+3*h]),i.vertex.push(s[0]),i.vertex.push(s[1]),i.vertex.push(s[2]);i.indices.push(r),i.indices.push(r+1),i.indices.push(r+2),i.indices.push(r),i.indices.push(r+2),i.indices.push(r+3);var l=[e[0]/16,e[1]/16,(e[0]+1)/16,(e[1]+1)/16];i.coords.push(l[0]),i.coords.push(l[1]),i.coords.push(l[2]),i.coords.push(l[1]),i.coords.push(l[2]),i.coords.push(l[3]),i.coords.push(l[0]),i.coords.push(l[3])};if(!u.air){var f=i;"water"==u.name&&(f=r);var v=null;(v=u.transparent?function(t){return t.transparent?t.name!=u.name:t.air}:function(t){return 1==t.transparent})(h.world.getBlock(l-1,d,c))&&p([0,1,1,0,1,0,0,0,0,0,0,1],u.sides,[-1,0,0],f),v(h.world.getBlock(l+1,d,c))&&p([1,1,0,1,1,1,1,0,1,1,0,0],u.sides,[1,0,0],f),v(h.world.getBlock(l,d,c-1))&&p([0,1,0,1,1,0,1,0,0,0,0,0],u.sides,[0,0,-1],f),v(h.world.getBlock(l,d,c+1))&&p([1,1,1,0,1,1,0,0,1,1,0,1],u.sides,[0,0,1],f),v(h.world.getBlock(l,d+1,c))&&p([0,1,1,1,1,1,1,1,0,0,1,0],u.top,[0,1,0],f),v(h.world.getBlock(l,d-1,c))&&p([0,0,0,1,0,0,1,0,1,0,0,1],u.bottom,[0,-1,0],f)}}var w=null,k=null;if(i.indices.length>0&&(w=h.rm.createMesh(s+"_bm",i)),r.indices.length>0&&(k=h.rm.createMesh(s+"_wm",r)),null!=w||null!=k){var x=new Float32Array(16);m(x),g(x,x,[e[0]*h.world.cl,e[1]*h.world.cl,e[2]*h.world.cl]),this.chunkMeshes.set(s,{model:x,block_mesh:w,water_mesh:k})}}resizeCanvas(t,e){(function(t,e,s,i,r){var n,o=1/Math.tan(e/2);t[0]=o/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(n=1/(i-r),t[10]=(r+i)*n,t[14]=2*r*i*n):(t[10]=-1,t[14]=-2*i)})(this.pMatrix,r(90),t/e,.1,1e3),this.canvas.width=t,this.canvas.height=e,this.gl.viewport(0,0,t,e)}setCam(t,e){var s=[-t[0],-t[1],-t[2]];m(this.vMatrix),p(this.vMatrix,this.vMatrix,r(e[0]),[1,0,0]),p(this.vMatrix,this.vMatrix,r(e[1]),[0,1,0]),p(this.vMatrix,this.vMatrix,r(e[2]),[0,0,1]),g(this.vMatrix,this.vMatrix,s);var i=new Float32Array(16);(function(t,e,s){var i=e[0],r=e[1],n=e[2],o=e[3],h=e[4],a=e[5],l=e[6],d=e[7],c=e[8],u=e[9],m=e[10],g=e[11],p=e[12],f=e[13],v=e[14],w=e[15],k=s[0],x=s[1],y=s[2],M=s[3];t[0]=k*i+x*h+y*c+M*p,t[1]=k*r+x*a+y*u+M*f,t[2]=k*n+x*l+y*m+M*v,t[3]=k*o+x*d+y*g+M*w,k=s[4],x=s[5],y=s[6],M=s[7],t[4]=k*i+x*h+y*c+M*p,t[5]=k*r+x*a+y*u+M*f,t[6]=k*n+x*l+y*m+M*v,t[7]=k*o+x*d+y*g+M*w,k=s[8],x=s[9],y=s[10],M=s[11],t[8]=k*i+x*h+y*c+M*p,t[9]=k*r+x*a+y*u+M*f,t[10]=k*n+x*l+y*m+M*v,t[11]=k*o+x*d+y*g+M*w,k=s[12],x=s[13],y=s[14],M=s[15],t[12]=k*i+x*h+y*c+M*p,t[13]=k*r+x*a+y*u+M*f,t[14]=k*n+x*l+y*m+M*v,t[15]=k*o+x*d+y*g+M*w})(i,this.pMatrix,this.vMatrix),function(t,e){var s=e[0],i=e[1],r=e[2],n=e[3],o=e[4],h=e[5],a=e[6],l=e[7],d=e[8],c=e[9],u=e[10],m=e[11],g=e[12],p=e[13],f=e[14],v=e[15],w=s*h-i*o,k=s*a-r*o,x=s*l-n*o,y=i*a-r*h,M=i*l-n*h,b=r*l-n*a,B=d*p-c*g,E=d*f-u*g,T=d*v-m*g,A=c*f-u*p,C=c*v-m*p,_=u*v-m*f,R=w*_-k*C+x*A+y*T-M*E+b*B;R&&(R=1/R,t[0]=(h*_-a*C+l*A)*R,t[1]=(r*C-i*_-n*A)*R,t[2]=(p*b-f*M+v*y)*R,t[3]=(u*M-c*b-m*y)*R,t[4]=(a*T-o*_-l*E)*R,t[5]=(s*_-r*T+n*E)*R,t[6]=(f*x-g*b-v*k)*R,t[7]=(d*b-u*x+m*k)*R,t[8]=(o*C-h*T+l*B)*R,t[9]=(i*T-s*C-n*B)*R,t[10]=(g*M-p*x+v*w)*R,t[11]=(c*x-d*M-m*w)*R,t[12]=(h*E-o*A-a*B)*R,t[13]=(s*A-i*E+r*B)*R,t[14]=(p*k-g*y-f*w)*R,t[15]=(d*y-c*k+u*w)*R)}(this.sToWorld,i)}screenToWorld(t,e){var s=[t/this.canvas.width*2-1,-e/this.canvas.height*2+1,0,1];return function(t,e,s){var i=e[0],r=e[1],n=e[2],o=e[3];t[0]=s[0]*i+s[4]*r+s[8]*n+s[12]*o,t[1]=s[1]*i+s[5]*r+s[9]*n+s[13]*o,t[2]=s[2]*i+s[6]*r+s[10]*n+s[14]*o,t[3]=s[3]*i+s[7]*r+s[11]*n+s[15]*o}(s,s,this.sToWorld),[s[0]/s[3],s[1]/s[3],s[2]/s[3]]}render(){this.canvas.width==window.innerWidth&&this.canvas.height==window.innerHeight||this.resizeCanvas(window.innerWidth,window.innerHeight),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND),this.gl.enable(this.gl.CULL_FACE),this.shader.bind(),this.gl.uniformMatrix4fv(this.pUniform,!1,this.pMatrix),this.gl.uniformMatrix4fv(this.vUniform,!1,this.vMatrix),this.altas.bind();var t=this;this.chunkMeshes.forEach((function(e,s,i){var r=e.block_mesh;r&&(t.gl.uniformMatrix4fv(t.mUniform,!1,e.model),r.bind(),r.draw(),r.unbind())})),this.altas.unbind(),this.models.forEach((function(e){e.tex.bind(),e.mesh.bind(),e.instances.forEach((function(s){t.gl.uniformMatrix4fv(t.mUniform,!1,s.matrix),e.mesh.draw()})),e.mesh.unbind(),e.tex.unbind()})),this.gl.disable(this.gl.CULL_FACE),this.altas.bind(),this.chunkMeshes.forEach((function(e,s,i){var r=e.water_mesh;r&&(t.gl.uniformMatrix4fv(t.mUniform,!1,e.model),r.bind(),r.draw(),r.unbind())})),this.altas.unbind(),this.shader.unbind()}}class v{constructor(){this.maps={w:87,s:83,jump:32,shift:16,a:65,d:68,noclip:78,physics:70},this.mx=0,this.my=0,this.ax=this.mx,this.ay=this.my,this.dx=0,this.dy=0,this.mp=!1,this.mrp=!1,this.ms=0,this.mrs=!1,this.state={},this.cx=0,this.cy=0,document.addEventListener("keydown",this.keydown.bind(this)),document.addEventListener("keyup",this.keyup.bind(this)),document.getElementById("glCanvas").addEventListener("mousemove",this.movemouse.bind(this)),document.getElementById("glCanvas").addEventListener("mousedown",this.mousedown.bind(this)),document.getElementById("glCanvas").addEventListener("mouseup",this.mouseup.bind(this))}keypress(t){var e=this.maps[t];if(null==e)return!1;var s=this.state[e];return null==s?(this.state[e]=!1,!1):s}update(){var t=document.getElementById("glCanvas").getBoundingClientRect();this.cx=t.x,this.cy=t.y,this.dx=this.mx-this.ax,this.dy=this.my-this.ay,this.ay=this.my,this.ax=this.mx,this.mp?this.ms=0==this.ms?1:-1:this.ms=0,this.mrp?this.mrs=0==this.mrs?1:-1:this.mrs=0}get mouseX(){return this.mx-this.cx}get mouseY(){return this.my-this.cy}get deltaX(){return this.dx}get deltaY(){return this.dy}get mousePressed(){return this.ms}get mouseRightPressed(){return this.mrs}keydown(t){this.state[t.keyCode]=!0}keyup(t){this.state[t.keyCode]=!1}movemouse(t){this.mx=t.clientX,this.my=t.clientY}mousedown(t){0==t.button&&(this.mp=!0),2==t.button&&(this.mrp=!0)}mouseup(t){0==t.button&&(this.mp=!1),2==t.button&&(this.mrp=!1)}}class w{static setGenInfo(){document.getElementById("main_menu").hidden=!0,document.getElementById("gen_info").hidden=!1,document.getElementById("selector").hidden=!0,document.getElementById("glCanvas").hidden=!0}static genInfoShowText(t){document.getElementById("gen_info").innerText=t}static setPlaying(t){document.getElementById("main_menu").hidden=!0,document.getElementById("gen_info").hidden=!0,document.getElementById("glCanvas").hidden=!1,document.getElementById("selector").hidden=!1;var e=document.getElementById("selector");e.hidden=!1;for(var s=0;s<h.selector.length;s++){var i=document.createElement("div");i.block=h.world.blockMaps.get(h.selector[s]);const r=i.block.sides;i.style.backgroundPosition=16*-r[0]*4+"px "+16*-r[1]*4+"px",i.style.backgroundSize="1024px 1024px",i.style.height="64px",i.style.width="64px",i.onclick=function(){t(this.block.name)},e.appendChild(i)}e.style.padding="4px",e.style.marginLeft=4+Math.floor(16*-h.selector.length*4/2)+"px"}}class k{constructor(t,e,s,i){this.gl=t,this.vao=t.createVertexArray(),this.len=i.length,t.bindVertexArray(this.vao),this.eb=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.eb),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint32Array(i),t.STATIC_DRAW),this.vertex=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertex),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),t.vertexAttribPointer(0,3,t.FLOAT,!1,24,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,3,t.FLOAT,!0,24,12),t.enableVertexAttribArray(1),this.txt=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.txt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),t.vertexAttribPointer(2,2,t.FLOAT,!0,0,0),t.enableVertexAttribArray(2),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.eb),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindVertexArray(null)}free(){this.gl.deleteBuffer(this.txt),this.gl.deleteBuffer(this.eb),this.gl.deleteBuffer(this.vertex),this.gl.deleteVertexArray(this.vao),this.vertex=null,this.vao=null,this.eb=null,this.txt=null}bind(){this.gl.bindVertexArray(this.vao)}unbind(){this.gl.bindVertexArray(null)}draw(){this.gl.drawElements(this.gl.TRIANGLES,this.len,this.gl.UNSIGNED_INT,0)}}function x(t,e,s){const i=t.createShader(e);return t.shaderSource(i,s),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(alert("Cannot create shader: "+t.getShaderInfoLog(i)),t.deleteShader(i),null)}class y{constructor(t,e,s){if(this.gl=t,this.vertex=x(t,t.VERTEX_SHADER,e),this.fragment=x(t,t.FRAGMENT_SHADER,s),this.program=t.createProgram(),t.attachShader(this.program,this.vertex),t.attachShader(this.program,this.fragment),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))return alert("Cannot link program "+t.getProgramInfoLog(shaderProgram)),t.deleteProgram(this.program),null}free(){this.gl.deleteShader(this.vertex),this.gl.deleteShader(this.fragment),this.gl.deleteProgram(this.program),this.vertex=null,this.fragment=null,this.program=null}bind(){this.gl.useProgram(this.program)}unbind(){this.gl.useProgram(null)}getUniform(t){return this.gl.getUniformLocation(this.program,t)}}class M{constructor(t,e){this.gl=t,this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.bindTexture(t.TEXTURE_2D,null)}free(){this.gl.deleteTexture(this.texture),this.texture=null}bind(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture)}unbind(){this.gl.bindTexture(this.gl.TEXTURE_2D,null)}}class b{constructor(){this.meshes=new Map,this.shaders=new Map,this.textures=new Map,this.images={}}async loadImages(){const t=t=>{const e=new Image;return e.src=`textures/${t}.png`,new Promise((s=>{e.onload=()=>{s()},this.images[t]=e}))};await t("atlas"),await t("wall")}free(){this.meshes.forEach((function(t){t.free()})),this.shaders.forEach((function(t){t.free()})),this.textures.forEach((function(t){t.free()}))}getTexture(t){var e=this.textures.get(t);return null==e&&(e=new M(this.gl,this.images[t]),this.textures.set(t,e)),e}createMesh(t,e){var s=this.meshes.get(t);return s&&s.free(),s=new k(this.gl,e.vertex,e.coords,e.indices),this.meshes.set(t,s),s}createShader(t,e,s){var i=this.meshes.get(t);return i&&i.free(),i=new y(this.gl,e,s),this.shaders.set(t,i),i}freeMesh(t){this.getMesh(t).free(),this.meshes.delete(t)}freeTexture(t){this.getTexture(t).free(),this.textures.delete(t)}freeShader(t){this.getShader(t).free(),this.shaders.delete(t)}getShader(t){return this.shaders.get(t)}getMesh(t){return this.meshes.get(t)}}var B=function(t,e,s,i){return new(s||(s=Promise))((function(r,n){function o(t){try{a(i.next(t))}catch(t){n(t)}}function h(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,h)}a((i=i.apply(t,e||[])).next())}))},E=function(t,e){var s,i,r,n,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return n={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function h(h){return function(a){return function(h){if(s)throw new TypeError("Generator is already executing.");for(;n&&(n=0,h[0]&&(o=0)),o;)try{if(s=1,i&&(r=2&h[0]?i.return:h[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,h[1])).done)return r;switch(i=0,r&&(h=[2&h[0],r.value]),h[0]){case 0:case 1:r=h;break;case 4:return o.label++,{value:h[1],done:!1};case 5:o.label++,i=h[1],h=[0];continue;case 7:h=o.ops.pop(),o.trys.pop();continue;default:if(!((r=(r=o.trys).length>0&&r[r.length-1])||6!==h[0]&&2!==h[0])){o=0;continue}if(3===h[0]&&(!r||h[1]>r[0]&&h[1]<r[3])){o.label=h[1];break}if(6===h[0]&&o.label<r[1]){o.label=r[1],r=h;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(h);break}r[2]&&o.ops.pop(),o.trys.pop();continue}h=e.call(t,o)}catch(t){h=[6,t],i=0}finally{s=r=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,a])}}};function T(){return B(this,void 0,void 0,(function(){var t,e,s;return E(this,(function(i){switch(i.label){case 0:return h.rm=new b,[4,h.rm.loadImages()];case 1:return i.sent(),w.setGenInfo(),t=new f,h.input=new v,e=document.getElementById("world_size"),s=parseInt(e.options[e.selectedIndex].value),h.world=new u(s,8,t),h.world.generateTerrain((function(t){w.genInfoShowText(t+"\nProgres: "+Math.floor(100*h.world.progress)+"%.")}),(function(){w.setPlaying((function(t){h.world.player.buildBlock=t})),h.world.autoLoadChunks();var e=Date.now(),s=0;t.clearColor(.53,.807,.98),requestAnimationFrame((function i(){var r=(Date.now()-e)/1e3;for(e=Date.now(),h.input.update(),h.world.update(r),t.render(),++s>=20&&(s=0);Date.now()-e<1e3/60;);requestAnimationFrame(i)}))})),[2]}}))}))}game=e})();